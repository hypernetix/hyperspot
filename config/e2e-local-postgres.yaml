# HyperSpot Server Configuration - E2E PostgreSQL
#
# Database Architecture Overview:
# ===============================
#
# HyperSpot uses a centralized DbManager that:
# 1. Loads global database server templates from `database.servers`
# 2. For each module, merges server template with module-specific overrides
# 3. Creates isolated database connections per module
# 4. Caches DbHandle instances for reuse within the same module
#
# Key principles:
# - Each module gets its own database connection (no sharing)
# - PostgreSQL modules use separate databases (settings_db, users_info_db)
# - Configuration follows a clear precedence hierarchy
# - Environment variables are expanded (${VAR_NAME})
# - All paths are resolved relative to server.home_dir

# Core server configuration (global section)
server:
  home_dir: "~/.hyperspot"
  allow_insecure_http: true

# Database configuration (DbManager architecture)
#
# The database config has two levels:
# 1. Global "servers" - shared connection templates that modules can reference
# 2. Per-module configs - specific database settings for each module
#
# Configuration precedence (highest to lowest):
# - Module `params` map (highest priority)
# - Module DSN query params
# - Module fields (host, port, user, etc.)
# - Module DSN base
# - Server `params` map
# - Server DSN query params
# - Server fields
# - Server DSN base (lowest priority)
#
database:
  # Global database servers - reusable connection templates
  # These define shared settings that multiple modules can inherit
  servers:
    postgres_base:
      # Shared connection pool configuration
      pool:
        max_conns: 10              # Default pool size for all modules
        acquire_timeout: "30s"     # Default timeout for acquiring connections
        min_conns: 2               # Minimum connections to maintain
        idle_timeout: "10m"        # Close idle connections after 10 minutes
      
      # Shared runtime parameters
      params:
        application_name: "hyperspot-e2e"  # Can be overridden per module
      
      # Default host/port (can be overridden by module DSN)
      host: "postgres"
      port: 5432

# Logging configuration (global section)
logging:
  # global section
  default:
    console_level: info
    file: "logs/hyperspot-e2e.log"
    file_level: info
    max_age_days: 28
    max_backups: 3
    max_size_mb: 10
  sqlx:
    console_level: debug
    file: "logs/sql.log"
    file_level: debug
  api-gateway:
    console_level: debug
    file: "logs/api.log"
    file_level: debug
    max_age_days: 28
    max_backups: 3
    max_size_mb: 100
  types-registry:
    console_level: info
    file: "logs/types_registry.log"
    file_level: debug
    max_age_days: 7
    max_backups: 3
    max_size_mb: 50


# Per-module configurations using new structure
modules:
  api-gateway:
    # No database needed for api-gateway
    config:
      bind_addr: "127.0.0.1:8086"
      enable_docs: true
      cors_enabled: false

      # OpenAPI Documentation Configuration
      openapi:
        title: "HyperSpot API"
        version: "0.1.0"
        description: "HyperSpot Server API Documentation"
      defaults:
        body_limit_bytes: 64000000
        rate_limit:
          rps: 1000
          burst: 200
          in_flight: 64

      # Authentication Configuration
      auth_disabled: true
      require_auth_by_default: true

      # JWKS Configuration (replace with your OIDC provider)
      jwks_uri: "http://localhost:8080/realms/dev/protocol/openid-connect/certs"
      issuer: "http://localhost:8080/realms/dev"
      audience: "api-gateway"

  # --- Tenant Resolver example (gateway + plugins) ---
  types-registry:
    config: {}

  contoso-tr-plugin:
    config:
      vendor: "Contoso"
      priority: 10

  fabrikam-tr-plugin:
    config:
      vendor: "Fabrikam"
      priority: 20
      # Tenant tree configuration (example: company with 2 divisions, each with departments)
      tenants:
        # Root tenant (company level)
        - id: "00000000000000000000000000000001"
          parent_id: null
          status: ACTIVE
          is_accessible_by_parent: true

        # Division 1: Engineering
        - id: "00000000000000000000000000000002"
          parent_id: "00000000000000000000000000000001"
          status: ACTIVE
          is_accessible_by_parent: true

        # Division 2: Sales
        - id: "00000000000000000000000000000005"
          parent_id: "00000000000000000000000000000001"
          status: ACTIVE
          is_accessible_by_parent: true

        # Department under Engineering: Frontend (soft-deleted, not accessible)
        - id: "00000000000000000000000000000003"
          parent_id: "00000000000000000000000000000002"
          status: SOFT_DELETED
          is_accessible_by_parent: false

        # Department under Engineering: Backend
        - id: "00000000000000000000000000000004"
          parent_id: "00000000000000000000000000000002"
          status: ACTIVE
          is_accessible_by_parent: true

        # Department under Sales: Enterprise
        - id: "00000000000000000000000000000006"
          parent_id: "00000000000000000000000000000005"
          status: ACTIVE
          is_accessible_by_parent: true

  tenant-resolver-gw:
    config:
      vendor: "Fabrikam"

  grpc-hub:
    config:
      listen_addr: "uds:///tmp/hyperspot-grpc-e2e"

  users-info:
    # Module-specific database configuration
    database:
      # Reference to global server template defined above
      server: "postgres_base"
      
      # Module-specific DSN overrides user, password, and database name
      dsn: "postgres://users_info_user:${USERS_INFO_DB_PASSWORD}@postgres:5432/users_info_db?application_name=hyperspot-users-info"
      
      # Alternative: Use fields instead of DSN to override only credentials
      # user: "users_info_user"
      # password: "${USERS_INFO_DB_PASSWORD}"
      # dbname: "users_info_db"
      # params:
      #   application_name: "hyperspot-users-info"
    
    # Module-specific application configuration
    config:
      default_page_size: 5
      max_page_size: 100

  simple-user-settings:
    # Module-specific database configuration
    database:
      server: "postgres_base"
      
      # Module-specific DSN overrides user, password, and database name
      dsn: "postgres://settings_user:${SETTINGS_DB_PASSWORD}@postgres:5432/settings_db?application_name=hyperspot-settings"
      
      # Alternative: Use fields instead of DSN to override only credentials
      # user: "settings_user"
      # password: "${SETTINGS_DB_PASSWORD}"
      # dbname: "settings_db"
      # params:
      #   application_name: "hyperspot-settings"
    
    config:
      max_field_length: 100

# OpenTelemetry tracing configuration
tracing:
  enabled: false
  service_name: "hyperspot-api"

  # OTLP exporter configuration
  exporter:
    kind: "otlp_grpc"  # or "otlp_http"
    endpoint: "http://127.0.0.1:14317"  # Jaeger OTLP gRPC endpoint
    # For HTTP: endpoint: "http://127.0.0.1:4318/v1/traces"
    headers:
      # Add any required headers, e.g., for authentication
      # authorization: "Bearer your-token"
      uptrace-dsn: "http://project1_secret@localhost:14318?grpc=14317"
    timeout_ms: 5000

  # Sampling configuration
  sampler:
    parent_based_ratio: # parent_based_always_on | parent_based_ratio | always_on | always_off
      ratio: 1.0  # Sample 20% of traces (only used with ratio strategies)

  # Propagation configuration
  propagation:
    w3c_trace_context: true  # Enable W3C Trace Context propagation

  # Resource attributes (added to all spans)
  resource:
    service.version: "1.3.7"
    deployment.environment: "dev"
    service.namespace: "hyperspot"

  # HTTP-specific options
  http:
    inject_request_id_header: "x-request-id"
    record_headers: [ "user-agent", "x-forwarded-for", "authorization" ]

  # Log correlation (future feature)
  logs_correlation:
    inject_trace_ids_into_logs: true
