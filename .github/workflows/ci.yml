name: CI

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  workflow_dispatch:

# Cancel previous runs for the same ref to save CI minutes.
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # We do NOT set RUSTC_WRAPPER globally; we'll enable it per-job after probing sccache.
  # RUSTC_WRAPPER: sccache
  SCCACHE_CACHE_SIZE: "2G"
  # Usually better determinism and smaller cache churn in CI.
  CARGO_INCREMENTAL: "0"

jobs:
  test:
    name: Lint + Test Suite (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - name: Force LF in working tree (w/a for Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate module naming conventions
        run: python3 scripts/validate_module_names.py

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # 1.92.0

      # Cache Cargo registry/git + target/ across platforms.
      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      # Install sccache (cross-platform)
      - name: Install sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      # Probe sccache; if startup fails, fall back to plain rustc (no hard CI failure).
      - name: Probe sccache & set RUSTC_WRAPPER
        shell: bash
        run: |
          if sccache --start-server >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
            echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          else
            echo "sccache failed, falling back to plain rustc"
          fi

      - name: cargo fmt (check)
        run: make fmt

      - name: cargo clippy
        env:
          RUSTFLAGS: "-C debuginfo=0 -C codegen-units=1"
        run: make clippy

      - name: cargo test (no macros)
        env:
          RUSTFLAGS: "-C debuginfo=0 -C codegen-units=1"
        run: make test-no-macros

      # Print sccache stats when active
      - name: sccache stats
        if: env.SCCACHE_GHA_ENABLED == 'true'
        run: sccache --show-stats

  cypilot:
    name: Cypilot
    uses: ./.github/workflows/cypilot.yml

  test_macros:
    name: UI macro tests (trybuild)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # 1.92.0

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      # Install sccache (cross-platform)
      - name: Install sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      # Probe sccache; if startup fails, fall back to plain rustc (no hard CI failure).
      - name: Probe sccache & set RUSTC_WRAPPER
        shell: bash
        run: |
          if sccache --start-server >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
            echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          else
            echo "sccache failed, falling back to plain rustc"
          fi

      - name: UI tests for modkit macros libraries
        env:
          RUSTFLAGS: "-C debuginfo=0 -C codegen-units=1"
        run: make test-macros
  security:
    name: Security (cargo-deny & cargo-audit on Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # 1.92.0

      # Install tools via prebuilt binaries for speed.
      - name: Install cargo-deny
        uses: taiki-e/install-action@30eab0fabba9ea3f522099957e668b21876aa39e # v2.66.6
        with:
          tool: cargo-deny

      # Run deny checks but do not fail CI (as requested).
      - name: cargo deny check
        run: make deny

  coverage:
    name: Code Coverage (cargo-llvm-cov)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain (with llvm-tools)
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly-2026-01-20
          components: llvm-tools-preview

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@30eab0fabba9ea3f522099957e668b21876aa39e # v2.66.6
        with:
          tool: cargo-llvm-cov

      # Generate lcov.info for upload. Customize flags/features as needed.
      - name: Coverage (lcov)
        env:
          RUSTFLAGS: "-C debuginfo=0 --cfg coverage_nightly"
          CARGO_LLVM_COV_TARGET_DIR: llvm-cov-target
          CARGO_LLVM_COV_BUILD_DIR: llvm-cov-build
          RUSTUP_TOOLCHAIN: nightly-2026-01-20
        run: |
          cargo llvm-cov clean --workspace
          cargo llvm-cov --workspace --lcov --output-path lcov.info

      # Upload to Codecov; do not fail CI if Codecov is down/misconfigured.
      - name: Upload to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4.6.0
        with:
          files: lcov.info
          fail_ci_if_error: false
          # token: ${{ secrets.CODECOV_TOKEN }}  # Uncomment if required for private repos

  modkit_db_integration:
    name: modkit-db integration (backend=${{ matrix.backend }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        backend: [ sqlite, pg, mysql ]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # 1.92.0

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Install sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Probe sccache & set RUSTC_WRAPPER
        shell: bash
        run: |
          if sccache --start-server >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
            echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          else
            echo "sccache failed, falling back to plain rustc"
          fi

      - name: Test modkit-db (integration)
        run: make test-${{ matrix.backend }}

      - name: sccache stats
        if: env.SCCACHE_GHA_ENABLED == 'true'
        run: sccache --show-stats

  users_info_integration_pg:
    name: users-info integration (Postgres)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # 1.92.0

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Install sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Probe sccache & set RUSTC_WRAPPER
        shell: bash
        run: |
          if sccache --start-server >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
            echo "SCCACHE_GHA_ENABLED=true" >> "$GITHUB_ENV"
          else
            echo "sccache failed, falling back to plain rustc"
          fi

      - name: Test users_info with Postgres (integration)
        run: make test-users-info-pg

      - name: sccache stats
        if: env.SCCACHE_GHA_ENABLED == 'true'
        run: sccache --show-stats

  dylint:
    name: Dylint Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: nightly-2025-09-18
          components: llvm-tools-preview,rustc-dev

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dylint-link
        uses: taiki-e/install-action@30eab0fabba9ea3f522099957e668b21876aa39e # v2.66.6
        with:
          tool: cargo-dylint,dylint-link

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Run dylint tests
        working-directory: dylint_lints
        run: cargo test

      - name: Run dylint on all crates
        run: make dylint
