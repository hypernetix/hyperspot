# This workflow intentionally runs only when Rust source files change.
# OpenAPI output is assumed to be fully derived from .rs files.
name: API Contracts

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.rs'

concurrency:
  group: api-contract-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  generate_api_json:
    name: Generate api.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          clean: 'true'
          submodules: recursive

      - name: Install protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: api-json

      - name: Fetch base ref
        env:
          BASE_REF: ${{ github.base_ref }}
        run: git fetch origin "${BASE_REF}" --depth=1
  
      - name: Save previous api.json
        id: save_prev
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          if [ -n "${BASE_REF}" ] && git show "origin/${BASE_REF}:docs/api/api.json" > docs/api/api.json.prev 2>/dev/null; then
            echo "prev_exists=true" >> $GITHUB_OUTPUT
          else
            echo "prev_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate api.json
        run: make openapi

      - name: Verify api.json was generated
        run: |
          if [ ! -f "docs/api/api.json" ]; then
            echo "Error: docs/api/api.json was not generated by 'make openapi'"
            echo "Listing docs/api directory:"
            ls -la docs/api/ || echo "docs/api directory does not exist"
            exit 1
          fi
          echo "api.json successfully generated"

      - name: Download oasdiff
        if: steps.save_prev.outputs.prev_exists == 'true'
        env:
          OASDIFF_VERSION: "1.11.10"
          OASDIFF_SHA256: "6d5880efb3422401f14c85f3c1347d6c41de3e4ea7c04e3ca7dc5c8f452e8ba2"
        run: |
          curl -sSL "https://github.com/oasdiff/oasdiff/releases/download/v${OASDIFF_VERSION}/oasdiff_${OASDIFF_VERSION}_linux_amd64.tar.gz" -o /tmp/oasdiff.tgz
          echo "${OASDIFF_SHA256}  /tmp/oasdiff.tgz" | sha256sum -c -
          tar -xzf /tmp/oasdiff.tgz -C /tmp
          sudo mv /tmp/oasdiff /usr/local/bin/oasdiff
          chmod +x /usr/local/bin/oasdiff

      - name: Check OpenAPI breaking changes
        if: steps.save_prev.outputs.prev_exists == 'true'
        run: |
          echo "Checking OpenAPI compatibility against previous version..."
          oasdiff diff --fail-on-breaking docs/api/api.json.prev docs/api/api.json

      - name: Skip OpenAPI compatibility check (no previous spec)
        if: steps.save_prev.outputs.prev_exists == 'false'
        run: |
          echo "No previous OpenAPI spec found; skipping compatibility check"
