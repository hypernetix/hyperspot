name: PR â†’ Pull Request Project Sync

on:
  schedule:
    - cron: "0 8 * * *"
    - cron: "0 13 * * *"

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      # -----------------------------
      # Organization / project
      # -----------------------------
      ORG: hypernetix
      PROJECT_NUMBER: 6

      # -----------------------------
      # GitHub Project IDs
      # -----------------------------
      PROJECT_ID: PVT_kwDOC9Ozis4BNo9m

      FIELD_LINK: PVTF_lADOC9Ozis4BNo9mzg8k3Co
      FIELD_UNREPLIED_THREADS: PVTF_lADOC9Ozis4BNo9mzg8k3Fg
      FIELD_UNREPLIED_COMMENTS: PVTF_lADOC9Ozis4BNo9mzg8k3HM

    steps:
      - name: Sync pull requests into GitHub Project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_DASHBOARD_PROJECTS_TOKEN }}

          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const {
              ORG,
              PROJECT_NUMBER,
              PROJECT_ID,
              FIELD_LINK,
              FIELD_UNREPLIED_THREADS,
              FIELD_UNREPLIED_COMMENTS
            } = process.env;

            /*
             ------------------------------------------------------------
             Load existing project items
             ------------------------------------------------------------
            */

            const projectData = await github.graphql(`
              query($org:String!, $number:Int!) {
                organization(login:$org) {
                  projectV2(number:$number) {
                    items(first:100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            id
                            title
                            closed
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, {
              org: ORG,
              number: Number(PROJECT_NUMBER)
            });

            const items =
              projectData.organization.projectV2.items.nodes;

            const projectItemsByPR = new Map();

            for (const item of items) {
              const title = item.content?.title;
              if (!title) continue;

              const m = title.match(/^PR #(\d+) - /);
              if (!m) continue;

              const prNumber = Number(m[1]);
              if (!Number.isFinite(prNumber)) continue;

              projectItemsByPR.set(
                prNumber,
                {
                  itemId: item.id,
                  issueNumber: item.content.number,
                  issueNodeId: item.content.id,
                  closed: item.content.closed
                }
              );
            }

            /*
             ------------------------------------------------------------
             Fetch open PRs
             ------------------------------------------------------------
            */

            const prs = await github.paginate(
              github.rest.pulls.list,
              {
                owner,
                repo,
                state: "open",
                per_page: 100
              }
            );

            const activePRs = new Set(prs.map(p => p.number));

            /*
             ------------------------------------------------------------
             Process each open PR
             ------------------------------------------------------------
            */

            for (const pr of prs) {

              const reviewData = await github.graphql(`
                query($owner:String!, $repo:String!, $number:Int!) {
                  repository(owner:$owner, name:$repo) {
                    pullRequest(number:$number) {
                      author { login }
                      reviewThreads(first:100) {
                        nodes {
                          isResolved
                          comments(last:50) {
                            nodes {
                              author { login }
                              url
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `, {
                owner,
                repo,
                number: pr.number
              });

              const author =
                reviewData.repository.pullRequest.author.login;

              let unrepliedThreads = 0;
              let unrepliedComments = 0;
              const links = [];

              for (const thread of reviewData.repository.pullRequest.reviewThreads.nodes) {
                if (thread.isResolved) continue;

                const comments = thread.comments.nodes;
                if (!comments.length) continue;

                const last = comments[comments.length - 1];

                if (last.author.login !== author) {
                  unrepliedThreads++;
                  unrepliedComments++;
                  links.push(last.url);
                }
              }

              /*
               ------------------------------------------------------------
               Ensure project item exists
               ------------------------------------------------------------
              */

              const issueTitle = `PR #${pr.number} - ${pr.title}`;

              const body =
                "Pull request:\n" +
                pr.html_url + "\n\n" +
                "Unreplied review comments:\n" +
                (links.length
                  ? links.map(l => "- " + l).join("\n")
                  : "None");

              let issue;

              {
                const searchTitle = issueTitle.replaceAll('"', '\\"');
                const search = await github.rest.search.issuesAndPullRequests({
                  q: `repo:${owner}/${repo} type:issue in:title "${searchTitle}"`,
                  per_page: 10
                });

                const match =
                  (search.data.items || []).find(i =>
                    i.title === issueTitle && !i.pull_request
                  );

                if (match) {
                  const existing = await github.rest.issues.get({
                    owner,
                    repo,
                    issue_number: match.number
                  });

                  issue = existing.data;
                }
              }

              if (!issue) {
                const created = await github.rest.issues.create({
                  owner,
                  repo,
                  title: issueTitle,
                  body
                });

                issue = created.data;
              } else {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issue.number,
                  title: issueTitle,
                  body
                });
              }

              let projectItem =
                projectItemsByPR.get(pr.number);

              let itemId;

              if (!projectItem) {
                const added = await github.graphql(`
                  mutation($project:ID!, $content:ID!) {
                    addProjectV2ItemById(
                      input:{
                        projectId:$project
                        contentId:$content
                      }
                    ) {
                      item { id }
                    }
                  }
                `, {
                  project: PROJECT_ID,
                  content: issue.node_id
                });

                itemId =
                  added.addProjectV2ItemById.item.id;

              } else {
                itemId = projectItem.itemId;
              }

              /*
               ------------------------------------------------------------
               Update project fields
               ------------------------------------------------------------
              */

              await github.graphql(`
                mutation(
                  $project: ID!
                  $item: ID!
                  $link: String!
                  $threads: Float!
                  $comments: Float!
                ) {
                  linkField: updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $project
                      itemId: $item
                      fieldId: "${FIELD_LINK}"
                      value: { text: $link }
                    }
                  ) {
                    projectV2Item { id }
                  }

                  threadsField: updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $project
                      itemId: $item
                      fieldId: "${FIELD_UNREPLIED_THREADS}"
                      value: { number: $threads }
                    }
                  ) {
                    projectV2Item { id }
                  }

                  commentsField: updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $project
                      itemId: $item
                      fieldId: "${FIELD_UNREPLIED_COMMENTS}"
                      value: { number: $comments }
                    }
                  ) {
                    projectV2Item { id }
                  }
                }
              `, {
                project: PROJECT_ID,
                item: itemId,
                link: pr.html_url,
                threads: unrepliedThreads,
                comments: unrepliedComments
              });
            }

            /*
             ------------------------------------------------------------
             Archive project items for closed PRs
             ------------------------------------------------------------
            */

            for (const [prNumber, item] of projectItemsByPR.entries()) {
              if (!activePRs.has(prNumber)) {
                if (item.issueNumber) {
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: item.issueNumber,
                    state: "closed"
                  });
                }

                await github.graphql(`
                  mutation($item:ID!) {
                    archiveProjectV2Item(
                      input:{ itemId:$item }
                    ) {
                      projectV2Item { id }
                    }
                  }
                `, {
                  item: item.itemId
                });
              }
            }
