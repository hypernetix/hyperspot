# Implementation Plan: GTS Core

**Feature**: `feature-gts-core`  
**Version**: 1.0  
**Last Updated**: 2026-01-06  
**Status**: ✅ COMPLETED

**Feature DESIGN**: `@/modules/analytics/architecture/features/feature-gts-core/DESIGN.md`

---

## Summary

**Total Changes**: 4  
**Completed**: 4  
**In Progress**: 0  
**Not Started**: 0

**Estimated Effort**: 16 story points

---

## Change 1: Routing Infrastructure

**ID**: `change-routing-infrastructure`  
**Status**: ✅ COMPLETED  
**Priority**: HIGH  
**Effort**: 5 story points  
**Implements**: `fdd-analytics-feature-gts-core-req-routing`

---

### Objective

Implement complete routing layer including routing table definition, GTS identifier parser, routing algorithm with O(1) hash lookup, and OpenAPI specification for unified /gts endpoints.

### Requirements Coverage

**Implements**:
- **`fdd-analytics-feature-gts-core-req-routing`**: The system SHALL implement a thin routing layer that routes GTS API requests to domain-specific features based on GTS type patterns with O(1) lookup performance

**References**:
- Actor Flow: Section B.4 - GTS Core Routes CRUD Operations
- Algorithm: Section C.1 - Routing Logic
- Technical Detail: Section E - API Endpoints

### Tasks

## 1. Implementation

### 1.1 Routing Infrastructure
- [x] 1.1.1 Create hash map data structure for GTS type pattern to feature mapping at `modules/analytics/gts-core/src/routing/table.rs`
- [x] 1.1.2 Implement GTS identifier parser to extract base type at `modules/analytics/gts-core/src/routing/parser.rs`
- [x] 1.1.3 Implement hash table lookup routing algorithm at `modules/analytics/gts-core/src/routing/router.rs`
- [x] 1.1.4 Define OpenAPI specification for unified /gts endpoints at `modules/analytics/architecture/openapi/v1/api.yaml`
- [x] 1.1.5 Implement RFC 7807 Problem Details error handling at `modules/analytics/gts-core/src/routing/errors.rs`

## 2. Testing

### 2.1 Routing Validation
- [x] 2.1.1 Verify all domain type patterns registered and O(1) lookup performance
- [x] 2.1.2 Verify GTS identifier parser handles all formats correctly
- [x] 2.1.3 Verify routing algorithm returns correct features for all patterns
- [x] 2.1.4 Verify OpenAPI schema valid with all CRUD operations documented
- [x] 2.1.5 Verify error handling returns clear messages with proper status codes

### Specification

**Domain Model Changes**: None (routing layer only)

**API Changes**:
- Endpoint: `/api/analytics/v1/gts`
- Methods: POST, GET
- Routing: Extracts GTS type from request, routes to domain feature
- Response: Proxies domain feature response

**Code Changes**:
- Module: `modules/analytics/gts-core/src/routing/`
- Functions:
  - `parse_gts_identifier(id: &str) -> Result<GtsType>`
  - `route_request(type: &GtsType) -> Result<&DomainFeature>`
  - `lookup_feature(type: &GtsType) -> Option<&DomainFeature>`
- Implementation: Hash table with O(1) lookup, no database queries

### Dependencies

**Depends on**: None (foundational change)

**Blocks**: Change 2, Change 3, Change 4

### Testing

**Unit Tests**:
- Test: Routing table lookup for all registered patterns
- File: `modules/analytics/gts-core/tests/routing/table_test.rs`
- Validates: All patterns route to correct features

**Unit Tests**:
- Test: GTS identifier parsing (named instances, UUID instances)
- File: `modules/analytics/gts-core/tests/routing/parser_test.rs`
- Validates: Extracts type correctly from various formats

**Integration Tests**:
- Test: End-to-end routing from HTTP request to domain feature
- File: `modules/analytics/gts-core/tests/integration/routing_test.rs`
- Validates: Request routed to correct feature, response returned

**Performance Tests**:
- Test: Routing decision time <1ms per request
- File: `modules/analytics/gts-core/tests/performance/routing_bench.rs`
- Validates: O(1) hash lookup performance

### Validation Criteria

**Code validation**:
- ✅ All tasks completed
- ✅ All tests pass
- ✅ O(1) routing performance verified
- ✅ No database queries in routing layer
- ✅ Implements `fdd-analytics-feature-gts-core-req-routing`

---

## Change 2: Request Middleware

**ID**: `change-request-middleware`  
**Status**: ✅ COMPLETED  
**Priority**: HIGH  
**Effort**: 5 story points  
**Implements**: `fdd-analytics-feature-gts-core-req-middleware`

---

### Objective

Implement request processing middleware chain including JWT validation, SecurityCtx injection with tenant isolation, OData v4 parameter parsing, and query optimization validator to prevent full table scans.

### Requirements Coverage

**Implements**:
- **`fdd-analytics-feature-gts-core-req-middleware`**: The system SHALL implement a middleware chain that validates JWT tokens, injects SecurityCtx with tenant isolation, and parses OData query parameters

**References**:
- Actor Flow: Section B.4 - Middleware Chain
- Algorithm: Section C.2 - Query Optimization Validator
- Technical Detail: Section E - Access Control

### Tasks

## 1. Implementation

### 1.1 Authentication Middleware
- [x] 1.1.1 Implement JWT validation middleware with signature verification at `modules/analytics/gts-core/src/middleware/auth.rs`
- [x] 1.1.2 Implement SecurityCtx injection from JWT claims at `modules/analytics/gts-core/src/middleware/security.rs`

### 1.2 Request Processing Middleware
- [x] 1.2.1 Implement OData parameter parser for $filter, $select, $orderby, $top, $skiptoken, $count at `modules/analytics/gts-core/src/middleware/odata.rs`
- [x] 1.2.2 Implement query optimization validator checking indexed fields at `modules/analytics/gts-core/src/middleware/query_validator.rs`
- [x] 1.2.3 Wire middleware chain (auth → security → odata → routing) at `modules/analytics/gts-core/src/middleware/mod.rs`

## 2. Testing

### 2.1 Authentication Tests
- [x] 2.1.1 Verify invalid JWTs rejected with HTTP 401
- [x] 2.1.2 Verify SecurityCtx correctly injected with tenant_id from JWT

### 2.2 Request Processing Tests
- [x] 2.2.1 Verify all OData v4 query parameters parsed correctly
- [x] 2.2.2 Verify unsupported filter fields return HTTP 400 with available fields list
- [x] 2.2.3 Verify middleware chain executes in correct order

### Specification

**API Changes**:
- All endpoints require JWT in Authorization header
- OData query parameters supported on GET /gts
- Query validation prevents full table scans

**Code Changes**:
- Module: `modules/analytics/gts-core/src/middleware/`
- Functions:
  - `validate_jwt(token: &str) -> Result<JwtClaims>`
  - `inject_security_ctx(claims: &JwtClaims) -> SecurityCtx`
  - `parse_odata_params(query: &str) -> Result<ODataParams>`
  - `validate_query_optimization(filter: &ODataFilter, indexed_fields: &[String]) -> Result<()>`
- Implementation: Middleware chain pattern, early returns on validation failure

### Dependencies

**Depends on**: Change 1 (routing infrastructure)

**Blocks**: Change 3, Change 4

### Testing

**Unit Tests**:
- Test: JWT validation with invalid signature
- File: `modules/analytics/gts-core/tests/middleware/auth_test.rs`
- Validates: HTTP 401 returned, no routing occurs

**Unit Tests**:
- Test: SecurityCtx injection with tenant_id from JWT
- File: `modules/analytics/gts-core/tests/middleware/security_test.rs`
- Validates: Correct tenant_id extracted and injected

**Unit Tests**:
- Test: OData parameter parsing (complex $filter expressions)
- File: `modules/analytics/gts-core/tests/middleware/odata_test.rs`
- Validates: All query parameters parsed into AST

**Unit Tests**:
- Test: Query optimization validator rejects unsupported fields
- File: `modules/analytics/gts-core/tests/middleware/query_validator_test.rs`
- Validates: HTTP 400 with available fields list

### Validation Criteria

**Code validation**:
- ✅ All tasks completed
- ✅ All tests pass
- ✅ JWT validation enforced on all endpoints
- ✅ OData v4 parameters supported
- ✅ Query optimization prevents full table scans
- ✅ Validation Score: 95/100 (OpenAPI alignment 95%)
- ✅ Implements `fdd-analytics-feature-gts-core-req-middleware`

---

## Change 3: Response Processing

**ID**: `change-response-processing`  
**Status**: ✅ COMPLETED  
**Priority**: HIGH  
**Effort**: 4 story points  
**Implements**: `fdd-analytics-feature-gts-core-req-tolerant-reader`, `fdd-analytics-feature-gts-core-req-routing`

---

### Objective

Implement response processing including Tolerant Reader pattern with field categorization, OData metadata aggregator for CSDL generation, and computed field injection.

### Requirements Coverage

**Implements**:
- **`fdd-analytics-feature-gts-core-req-tolerant-reader`**: The system SHALL implement the Tolerant Reader pattern to handle field semantics across create, read, and update operations
- **`fdd-analytics-feature-gts-core-req-routing`**: OData metadata aggregation from all domain features

**References**:
- Algorithm: Section C.3 - Tolerant Reader Pattern
- Actor Flow: Section B.5 - Aggregate OData Metadata
- Technical Detail: Section E - Tolerant Reader Pattern

### Tasks

## 1. Implementation

### 1.1 Field Handling
- [x] 1.1.1 Implement field handler with categorization (client-provided, server-managed, computed, never-returned) at `modules/analytics/gts-core/src/response/field_handler.rs`
- [x] 1.1.2 Add secret field filtering for API keys and credentials at `modules/analytics/gts-core/src/response/field_handler.rs`
- [x] 1.1.3 Implement computed field injection (asset_path, etc.) at `modules/analytics/gts-core/src/response/computed_fields.rs`

### 1.2 Response Processing
- [x] 1.2.1 Implement response processor with secret filtering and field injection at `modules/analytics/gts-core/src/response/response_processor.rs`
- [x] 1.2.2 Implement OData metadata aggregator collecting entity type definitions at `modules/analytics/gts-core/src/response/metadata.rs`

## 2. Testing

### 2.1 Field Handler Tests
- [x] 2.1.1 Verify correct field handling per category (284 lines implemented)
- [x] 2.1.2 Verify 5 secret patterns filtered (entity/api_key, entity/credentials, etc.)
- [x] 2.1.3 Verify computed fields present in GET responses

### 2.2 Response Processing Tests
- [x] 2.2.1 Verify secrets excluded and computed fields added (117 lines implemented)
- [x] 2.2.2 Verify valid OData JSON CSDL output from metadata aggregator

### Specification

**Field Categories**:
- **Client-provided**: entity.*, user-submitted data
- **Server-managed** (9 fields): id, type, registered_at, updated_at, deleted_at, registered_by, updated_by, deleted_by, tenant
- **Secret patterns** (5): entity/api_key, entity/credentials, entity/secret, entity/token, entity/password
- **Computed** (1+): asset_path, type-specific properties

**API Changes**:
- POST/PUT: Client values accepted for entity.*, system fields ignored
- GET: Secrets excluded, computed fields added
- PATCH: Only /entity/* paths allowed

**Code Changes**:
- Module: `modules/analytics/gts-core/src/response/`
- Functions:
  - `categorize_field(path: &str) -> FieldCategory`
  - `filter_secrets(entity: &mut Value)`
  - `inject_computed_fields(entity: &mut Value, ctx: &Context)`
  - `aggregate_metadata(features: &[DomainFeature]) -> ODataCsdl`
- Implementation: Tolerant Reader pattern, recursive field traversal (top-level only for secrets)

### Dependencies

**Depends on**: Change 1 (routing), Change 2 (middleware)

**Blocks**: Change 4

### Testing

**Unit Tests**:
- Test: Client cannot override system fields (id, type, tenant)
- File: `modules/analytics/gts-core/tests/response/field_handler_test.rs`
- Validates: System fields ignored in POST, generated values used (10 tests)

**Unit Tests**:
- Test: Secrets excluded from GET responses
- File: `modules/analytics/gts-core/tests/response/response_processor_test.rs`
- Validates: API keys and credentials not returned (5 tests)

**Integration Tests**:
- Test: End-to-end Tolerant Reader pattern
- File: `modules/analytics/gts-core/tests/integration/tolerant_reader_test.rs`
- Validates: All field categories handled correctly (10 tests)

**Edge Case Tests**:
- Test: PATCH operations restricted to /entity/* paths
- File: `modules/analytics/gts-core/tests/integration/patch_test.rs`
- Validates: System field modification rejected with HTTP 400

### Validation Criteria

**Code validation**:
- ✅ All tasks completed
- ✅ All 25 tests passing (10 unit + 5 response processor + 10 integration/edge)
- ✅ Field categories correctly implemented
- ✅ Secrets filtered from responses
- ✅ Computed fields injected on read
- ✅ Validation Score: 98/100 (OpenAPI alignment 98%)
- ✅ Implements `fdd-analytics-feature-gts-core-req-tolerant-reader`

**Known Limitations**:
- Secret field list is hard-coded (-1 point): Future enhancement to read from GTS schemas
- Nested secret filtering limited to top-level fields (-1 point): Future recursive traversal

---

## Change 4: Quality Assurance

**ID**: `change-quality-assurance`  
**Status**: ✅ COMPLETED  
**Priority**: MEDIUM  
**Effort**: 2 story points  
**Implements**: `fdd-analytics-feature-gts-core-req-routing`, `fdd-analytics-feature-gts-core-req-middleware`, `fdd-analytics-feature-gts-core-req-tolerant-reader`

---

### Objective

Implement RFC 7807 Problem Details error handling for all error cases and comprehensive end-to-end integration tests with mock domain features covering all requirements.

### Requirements Coverage

**Implements**:
- **`fdd-analytics-feature-gts-core-req-routing`**: Error handling for routing failures
- **`fdd-analytics-feature-gts-core-req-middleware`**: Error handling for authentication and validation failures
- **`fdd-analytics-feature-gts-core-req-tolerant-reader`**: Error handling for field validation failures

**References**:
- Technical Detail: Section E - Error Handling
- All Testing Scenarios from Section F

### Tasks

## 1. Implementation

### 1.1 Error Handling
- [x] 1.1.1 Implement RFC 7807 Problem Details error format at `modules/analytics/gts-core/src/errors/problem_details.rs`

## 2. Testing

### 2.1 Integration Tests
- [x] 2.1.1 Create comprehensive end-to-end test suite with mock domain features at `modules/analytics/gts-core/tests/integration/`
- [x] 2.1.2 Verify end-to-end registration flow routes correctly
- [x] 2.1.3 Verify OData query routing across multiple features with pagination
- [x] 2.1.4 Verify multi-feature metadata aggregation produces valid CSDL

### 2.2 Performance Tests
- [x] 2.2.1 Add performance benchmarks at `modules/analytics/gts-core/tests/performance/`
- [x] 2.2.2 Verify routing overhead <1ms per request with O(1) hash lookup

### 2.3 Edge Case Tests
- [x] 2.3.1 Test malformed identifiers, empty routing table, feature errors at `modules/analytics/gts-core/tests/edge_cases/`
- [x] 2.3.2 Verify all edge cases (malformed IDs, empty routing table, very long IDs >500 chars, special characters) handled gracefully

### 2.4 Validation
- [x] 2.4.1 Verify all errors use RFC 7807 format
- [x] 2.4.2 Verify all requirements covered by tests

### Specification

**Error Handling**:
- All errors use RFC 7807 Problem Details format
- Common errors: 404 (unknown type), 400 (invalid identifier), 401 (invalid JWT), 503 (feature unavailable)
- Retry strategy: 404 (no retry), 503 (retry with backoff), 401 (refresh token)

**Testing Coverage**:
- Unit tests: Routing, middleware, response processing
- Integration tests: End-to-end flows with mock features
- Performance tests: <1ms routing overhead, O(1) lookup
- Edge cases: Malformed IDs, empty routing table, very long IDs (>500 chars)

**Code Changes**:
- Module: `modules/analytics/gts-core/src/errors/`
- Functions:
  - `to_problem_details(error: &Error) -> ProblemDetails`
  - `routing_error(type: &GtsType) -> ProblemDetails`
  - `auth_error(reason: &str) -> ProblemDetails`
- Implementation: Comprehensive error mapping, structured logging

### Dependencies

**Depends on**: Change 1, Change 2, Change 3

**Blocks**: None (final change)

### Testing

**Integration Tests**:
- Test: End-to-end registration flow
- File: `modules/analytics/gts-core/tests/integration/registration_test.rs`
- Validates: Type registration routed correctly, response matches schema

**Integration Tests**:
- Test: OData query routing across multiple features
- File: `modules/analytics/gts-core/tests/integration/odata_test.rs`
- Validates: Complex filters work, pagination correct

**Integration Tests**:
- Test: Multi-feature metadata aggregation
- File: `modules/analytics/gts-core/tests/integration/metadata_test.rs`
- Validates: Complete CSDL from all features, valid OData schema

**Performance Tests**:
- Test: Routing overhead measurement
- File: `modules/analytics/gts-core/tests/performance/routing_bench.rs`
- Validates: <1ms per request, O(1) hash lookup

**Edge Case Tests**:
- Test: Malformed GTS identifier, empty routing table, feature errors, long IDs, special characters
- File: `modules/analytics/gts-core/tests/edge_cases/routing_edge_cases_test.rs`
- Validates: All edge cases handled gracefully with proper errors

### Validation Criteria

**Code validation**:
- ✅ All tasks completed
- ✅ All tests pass
- ✅ RFC 7807 error format for all errors
- ✅ Comprehensive integration test coverage
- ✅ Performance benchmarks pass (<1ms routing)
- ✅ All edge cases tested
- ✅ Validation Score: 100/100 (OpenSpec 100%, ModKit 95%, GTS 100%)
- ✅ Completed: 2026-01-06
- ✅ Implements all three core requirements

---
