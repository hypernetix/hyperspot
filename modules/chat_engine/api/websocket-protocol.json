{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "gts://gts.x.chat_engine.api.websocket_protocol.v1~",
  "title": "Chat Engine WebSocket Protocol",
  "description": "WebSocket API protocol specification for Chat Engine streaming operations. This protocol is used exclusively for operations that require real-time streaming responses and server-initiated push notifications. All CRUD operations, queries, and simple control operations use the HTTP REST API instead.",
  "type": "object",
  "properties": {
    "protocol": {
      "type": "string",
      "const": "chat_engine_websocket",
      "description": "Protocol identifier"
    },
    "version": {
      "type": "string",
      "const": "2.0",
      "description": "Protocol version (2.0 - split HTTP/WebSocket)"
    },
    "transport": {
      "type": "string",
      "const": "websocket",
      "description": "Transport type"
    },
    "connection": {
      "type": "object",
      "description": "WebSocket connection configuration",
      "properties": {
        "url_pattern": {
          "type": "string",
          "const": "wss://chat-engine/ws",
          "description": "WebSocket connection URL pattern"
        },
        "authentication": {
          "type": "object",
          "description": "Authentication mechanism",
          "properties": {
            "type": {
              "type": "string",
              "const": "jwt",
              "description": "Authentication type"
            },
            "location": {
              "type": "string",
              "enum": ["handshake", "first_message"],
              "description": "Where JWT token is provided - either in Sec-WebSocket-Protocol header during handshake or in first message after connection"
            }
          },
          "required": ["type", "location"]
        },
        "keepalive": {
          "type": "object",
          "description": "Connection keepalive configuration",
          "properties": {
            "interval_seconds": {
              "type": "integer",
              "const": 30,
              "description": "Keepalive interval in seconds"
            },
            "mechanism": {
              "type": "string",
              "const": "ping_pong",
              "description": "Keepalive mechanism (WebSocket ping/pong frames)"
            }
          },
          "required": ["interval_seconds", "mechanism"]
        }
      },
      "required": ["url_pattern", "authentication", "keepalive"]
    },
    "message_format": {
      "type": "object",
      "description": "Base WebSocket message envelope format",
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique message ID for request/response matching"
        },
        "type": {
          "type": "string",
          "description": "Event type identifier"
        },
        "payload": {
          "type": "object",
          "description": "Event-specific data payload"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp"
        }
      },
      "required": ["id", "type", "payload", "timestamp"]
    },
    "client_to_server": {
      "type": "object",
      "description": "Client → Server streaming operations",
      "properties": {
        "operations": {
          "type": "array",
          "description": "Streaming operations that require WebSocket",
          "items": [
            {
              "type": "object",
              "properties": {
                "operation_id": {
                  "type": "string",
                  "const": "message.send"
                },
                "event_type": {
                  "type": "string",
                  "const": "message.send"
                },
                "category": {
                  "type": "string",
                  "const": "message_operations"
                },
                "description": {
                  "type": "string",
                  "const": "Send message and receive streaming response"
                },
                "request_payload": {
                  "type": "object",
                  "required": ["session_id", "content"],
                  "properties": {
                    "session_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "content": {
                      "type": "string"
                    },
                    "file_urls": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "parent_message_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "enabled_capabilities": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                },
                "response": {
                  "type": "string",
                  "const": "Streaming sequence: message.streaming.start → message.streaming.chunk (multiple) → message.streaming.complete or message.streaming.error"
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "operation_id": {
                  "type": "string",
                  "const": "message.recreate"
                },
                "event_type": {
                  "type": "string",
                  "const": "message.recreate"
                },
                "category": {
                  "type": "string",
                  "const": "message_operations"
                },
                "description": {
                  "type": "string",
                  "const": "Recreate assistant response with streaming"
                },
                "request_payload": {
                  "type": "object",
                  "required": ["message_id"],
                  "properties": {
                    "message_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "enabled_capabilities": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                },
                "response": {
                  "type": "string",
                  "const": "Streaming sequence: message.streaming.start → message.streaming.chunk (multiple) → message.streaming.complete or message.streaming.error"
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "operation_id": {
                  "type": "string",
                  "const": "session.summarize"
                },
                "event_type": {
                  "type": "string",
                  "const": "session.summarize"
                },
                "category": {
                  "type": "string",
                  "const": "utility"
                },
                "description": {
                  "type": "string",
                  "const": "Generate session summary with streaming response"
                },
                "request_payload": {
                  "type": "object",
                  "required": ["session_id"],
                  "properties": {
                    "session_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "enabled_capabilities": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                },
                "response": {
                  "type": "string",
                  "const": "Streaming sequence: message.streaming.start → message.streaming.chunk (multiple) → message.streaming.complete or message.streaming.error"
                }
              }
            }
          ]
        }
      }
    },
    "server_to_client": {
      "type": "object",
      "description": "Server → Client events",
      "properties": {
        "connection_events": {
          "type": "array",
          "description": "Connection lifecycle events",
          "items": [
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "connection.ready"
                },
                "description": {
                  "type": "string",
                  "const": "Connection established successfully"
                },
                "payload": {
                  "type": "object",
                  "properties": {
                    "client_id": {
                      "type": "string"
                    },
                    "server_version": {
                      "type": "string"
                    },
                    "capabilities": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "connection.error"
                },
                "description": {
                  "type": "string",
                  "const": "Connection-level error"
                },
                "payload": {
                  "type": "object",
                  "properties": {
                    "error_code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    },
                    "details": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          ]
        },
        "response_events": {
          "type": "array",
          "description": "Request/response events for WebSocket operations",
          "items": [
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "response.success"
                },
                "description": {
                  "type": "string",
                  "const": "Operation succeeded"
                },
                "payload": {
                  "type": "object",
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "result": {
                      "type": "object"
                    }
                  }
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "response.error"
                },
                "description": {
                  "type": "string",
                  "const": "Operation failed"
                },
                "payload": {
                  "type": "object",
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "error_code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    },
                    "details": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          ]
        },
        "streaming_events": {
          "type": "array",
          "description": "Real-time streaming events",
          "items": [
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "message.streaming.start"
                },
                "description": {
                  "type": "string",
                  "const": "Streaming response started"
                },
                "payload": {
                  "type": "object",
                  "required": ["request_id", "message_id"],
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "message_id": {
                      "type": "string",
                      "format": "uuid"
                    }
                  }
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "message.streaming.chunk"
                },
                "description": {
                  "type": "string",
                  "const": "Streaming data chunk"
                },
                "payload": {
                  "type": "object",
                  "required": ["request_id", "message_id", "chunk"],
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "message_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "chunk": {
                      "type": "object",
                      "properties": {
                        "type": {
                          "type": "string",
                          "enum": ["text", "code", "image", "audio", "video", "document"]
                        },
                        "content": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "message.streaming.complete"
                },
                "description": {
                  "type": "string",
                  "const": "Streaming finished successfully"
                },
                "payload": {
                  "type": "object",
                  "required": ["request_id", "message_id"],
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "message_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "usage": {
                          "type": "object",
                          "properties": {
                            "input_tokens": {
                              "type": "integer"
                            },
                            "output_tokens": {
                              "type": "integer"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "message.streaming.error"
                },
                "description": {
                  "type": "string",
                  "const": "Streaming error occurred"
                },
                "payload": {
                  "type": "object",
                  "required": ["request_id", "message_id", "error_code", "message"],
                  "properties": {
                    "request_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "message_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "error_code": {
                      "type": "string"
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          ]
        },
        "push_events": {
          "type": "array",
          "description": "Server-initiated push notifications",
          "items": [
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "session.updated"
                },
                "description": {
                  "type": "string",
                  "const": "Session state changed - sent when session metadata, capabilities, or type changes"
                },
                "payload": {
                  "type": "object",
                  "required": ["session_id", "updates"],
                  "properties": {
                    "session_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "updates": {
                      "type": "object",
                      "description": "Changed fields"
                    }
                  }
                }
              }
            },
            {
              "type": "object",
              "properties": {
                "event_type": {
                  "type": "string",
                  "const": "message.created"
                },
                "description": {
                  "type": "string",
                  "const": "New message persisted - sent when a message is successfully saved to database"
                },
                "payload": {
                  "type": "object",
                  "required": ["session_id", "message"],
                  "properties": {
                    "session_id": {
                      "type": "string",
                      "format": "uuid"
                    },
                    "message": {
                      "type": "object",
                      "description": "Full message object"
                    }
                  }
                }
              }
            }
          ]
        }
      }
    },
    "error_codes": {
      "type": "array",
      "description": "Standard error codes used in WebSocket protocol",
      "items": [
        {
          "code": "AUTH_REQUIRED",
          "description": "Authentication failed or missing"
        },
        {
          "code": "SESSION_NOT_FOUND",
          "description": "Session doesn't exist"
        },
        {
          "code": "MESSAGE_NOT_FOUND",
          "description": "Message doesn't exist"
        },
        {
          "code": "INVALID_REQUEST",
          "description": "Malformed request payload"
        },
        {
          "code": "BACKEND_TIMEOUT",
          "description": "Webhook backend timeout"
        },
        {
          "code": "BACKEND_ERROR",
          "description": "Webhook backend error"
        },
        {
          "code": "RATE_LIMIT_EXCEEDED",
          "description": "Too many requests"
        },
        {
          "code": "INTERNAL_ERROR",
          "description": "Server internal error"
        }
      ]
    },
    "design_rationale": {
      "type": "object",
      "description": "Why WebSocket is used only for these operations",
      "properties": {
        "streaming_requirements": {
          "type": "string",
          "const": "message.send, message.recreate, and session.summarize require real-time streaming of incremental responses from webhook backends"
        },
        "low_latency": {
          "type": "string",
          "const": "WebSocket maintains persistent connection avoiding repeated handshake overhead"
        },
        "push_notifications": {
          "type": "string",
          "const": "Server can push session.updated and message.created events without client polling"
        },
        "bidirectional": {
          "type": "string",
          "const": "Client can send control commands (like stop) during streaming"
        },
        "crud_via_http": {
          "type": "string",
          "const": "Simple request/response operations (GET session, DELETE session, etc.) use HTTP REST API for better tooling, caching, debugging, and standard patterns"
        }
      }
    }
  },
  "required": ["protocol", "version", "transport", "connection", "message_format", "client_to_server", "server_to_client", "error_codes"]
}
